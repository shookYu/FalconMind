# FalconMindSDK 示例04：Bus消息总线

## 概述

本示例演示如何使用FalconMindSDK的Bus消息总线进行节点间和Pipeline间的消息通信。Bus是SDK中的发布/订阅模式实现，支持异步消息传递。

## 测试的SDK API

本示例测试了以下核心SDK API：

### Bus核心API
| API | 功能 | 验证 |
|-----|------|------|
| `Bus::subscribe()` | 订阅消息频道 | ✅ |
| `Bus::unsubscribe()` | 取消订阅 | ✅ |
| `Bus::post()` | 发布消息 | ✅ |

## 架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Bus 消息总线架构                                   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │                    发布/订阅模式                              │      │
│   │                                                              │      │
│   │   [Publisher] ──────▶ Bus ──────▶ [Subscriber 1]            │      │
│   │                        │                                     │      │
│   │                        │                                     │      │
│   │                        └─────▶ [Subscriber 2]               │      │
│   │                        │                                     │      │
│   │                        │                                     │      │
│   │                        └─────▶ [Subscriber N]               │      │
│   │                                                              │      │
│   │   消息流向: 发布者 → Bus → 订阅者                             │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │                    消息类型                                  │      │
│   │                                                              │      │
│   │   category: 消息类别（如 "detection", "telemetry"）        │      │
│   │   text:     消息内容                                        │      │
│   │                                                              │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 支持的平台

### x86平台
```
┌─────────────────────────────────────────────────────────────────┐
│                      x86 平台配置                           │
├─────────────────────────────────────────────────────────────────┤
│  处理器架构:      x86_64                                    │
│  适用场景:        开发、测试环境                            │
│  编译方式:        本地编译 (gcc/g++)                       │
│                                                                 │
│  编译命令:                                                        │
│    cd x86                                                       │
│    mkdir -p build && cd build                                   │
│    cmake -DCMAKE_BUILD_TYPE=Release ..                          │
│    make -j4                                                    │
│                                                                 │
│  运行命令:                                                        │
│    ./04_bus_messaging_x86                                       │
└─────────────────────────────────────────────────────────────────┘
```

### RK3576平台
```
┌─────────────────────────────────────────────────────────────────┐
│                     RK3576 平台配置                           │
├─────────────────────────────────────────────────────────────────┤
│  处理器架构:      ARM Cortex-A76 (64-bit)                      │
│  NPU算力:        6 TOPS                                        │
│  编译方式:        交叉编译 (aarch64-linux-gnu)               │
│                                                                 │
│  交叉编译命令:                                                   │
│    cd rk3576                                                   │
│    mkdir -p build && cd build                                 │
│    cmake -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake ..        │
│    make -j4                                                    │
└─────────────────────────────────────────────────────────────────┘
```

### RV1126B平台
```
┌─────────────────────────────────────────────────────────────────┐
│                     RV1126B 平台配置                           │
├─────────────────────────────────────────────────────────────────┤
│  处理器架构:      ARM Cortex-A53 (64-bit)                      │
│  NPU算力:        3.0 TOPS                                      │
│  编译方式:        交叉编译 (aarch64-linux-gnu)               │
│                                                                 │
│  交叉编译命令:                                                   │
│    cd rv1126b                                                  │
│    mkdir -p build && cd build                                 │
│    cmake -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake ..        │
│    make -j4                                                    │
└─────────────────────────────────────────────────────────────────┘
```

### RK3588平台
```
┌─────────────────────────────────────────────────────────────────┐
│                     RK3588 平台配置                           │
├─────────────────────────────────────────────────────────────────┤
│  处理器架构:      ARM Cortex-A76×4 + Cortex-A55×4              │
│  NPU算力:        6 TOPS (集成3核NPU)                         │
│  编译方式:        交叉编译 (aarch64-linux-gnu)               │
│                                                                 │
│  交叉编译命令:                                                   │
│    cd rk3588                                                   │
│    mkdir -p build && cd build                                 │
│    cmake -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake ..        │
│    make -j4                                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 目录结构

```
04_bus_messaging/
├── README.md                    # 本文档
│
├── x86/                         # x86平台
│   ├── CMakeLists.txt           # x86平台CMake配置
│   ├── src/
│   │   └── main.cpp            # x86平台源代码
│   └── build/                  # 构建目录
│
├── rk3576/                      # RK3576平台
│   ├── CMakeLists.txt           # RK3576交叉编译配置
│   ├── toolchain.cmake         # 交叉编译工具链文件
│   ├── src/
│   │   └── main.cpp            # RK3576平台源代码
│   └── build/
│
├── rv1126b/                     # RV1126B平台
│   ├── CMakeLists.txt           # RV1126B交叉编译配置
│   ├── toolchain.cmake         # 交叉编译工具链文件
│   ├── src/
│   │   └── main.cpp            # RV1126B平台源代码
│   └── build/
│
├── rk3588/                      # RK3588平台
│   ├── CMakeLists.txt           # RK3588交叉编译配置
│   ├── toolchain.cmake         # 交叉编译工具链文件
│   ├── src/
│   │   └── main.cpp            # RK3588平台源代码
│   └── build/
│
└── tests/                      # 测试脚本
    ├── build_all.sh            # 一键构建所有平台
    ├── build_x86.sh            # x86本地编译脚本
    ├── build_rv1126b.sh        # RV1126B交叉编译脚本
    ├── build_rk3576.sh         # RK3576交叉编译脚本
    └── build_rk3588.sh         # RK3588交叉编译脚本
```

## 快速开始

### 使用自动构建脚本

```bash
cd 04_bus_messaging/tests
chmod +x build_all.sh
./build_all.sh
```

### x86平台手动编译

```bash
cd 04_bus_messaging/x86
mkdir -p build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j$(nproc)
./04_bus_messaging_x86
```

## 示例功能详解

### 1. 创建Bus实例

```cpp
auto bus = std::make_shared<Bus>();
```

### 2. 订阅消息

```cpp
// 订阅检测消息
int detectId = bus->subscribe([](const BusMessage& msg) {
    std::cout << "[检测] " << msg.category << ": " << msg.text << std::endl;
});

// 订阅遥测消息
int telemetryId = bus->subscribe([](const BusMessage& msg) {
    std::cout << "[遥测] " << msg.category << ": " << msg.text << std::endl;
});
```

### 3. 发布消息

```cpp
bus->post(BusMessage{"detection", "目标检测结果: 车辆, 置信度: 0.95"});
bus->post(BusMessage{"telemetry", "高度: 100m, 速度: 20m/s"});
```

### 4. 取消订阅

```cpp
bus->unsubscribe(detectId);
```

## 完整执行流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Bus 执行流程                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 创建Bus实例                                                        │
│     ┌──────────────────────────────────────────────────────┐             │
│     │ Bus::Bus()                                             │             │
│     │         │                                             │             │
│     │         ▼                                             │             │
│     │     handlers_ = empty                                 │             │
│     │     nextId_ = 1                                       │             │
│     └──────────────────────────────────────────────────────┘             │
│                                                                         │
│  2. 订阅消息                                                           │
│     ┌──────────────────────────────────────────────────────┐             │
│     │ Bus::subscribe(handler)                               │             │
│     │         │                                             │             │
│     │         ▼                                             │             │
│     │     id = nextId_++                                   │             │
│     │     handlers_[id] = handler                           │             │
│     │     return id                                         │             │
│     └──────────────────────────────────────────────────────┘             │
│                                                                         │
│  3. 发布消息                                                           │
│     ┌──────────────────────────────────────────────────────┐             │
│     │ Bus::post(message)                                    │             │
│     │         │                                             │             │
│     │         ▼                                             │             │
│     │     for each handler:                                 │             │
│     │         handler(message)                               │             │
│     └──────────────────────────────────────────────────────┘             │
│                                                                         │
│  4. 取消订阅                                                           │
│     ┌──────────────────────────────────────────────────────┐             │
│     │ Bus::unsubscribe(id)                                  │             │
│     │         │                                             │             │
│     │         ▼                                             │             │
│     │     handlers_.erase(id)                               │             │
│     └──────────────────────────────────────────────────────┘             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 代码结构说明

### 头文件包含
```cpp
#include "falconmind/sdk/core/Bus.h"    // Bus核心类
```

### BusMessage结构
```cpp
struct BusMessage {
    std::string category;    // 消息类别
    std::string text;        // 消息内容
};
```

### Bus类定义

**Bus职责**:
```
Bus消息总线:
├── subscribe(handler)   - 订阅消息，返回订阅ID
├── unsubscribe(id)       - 取消订阅
└── post(message)         - 发布消息到所有订阅者
```

## 常见问题

### Q1: 订阅后收不到消息
```bash
# 检查订阅ID是否正确
int id = bus->subscribe(...);
# 发布消息时，确保订阅仍有效
bus->unsubscribe(id);  // 取消订阅后无法收到消息
```

### Q2: 多次订阅同一消息
```bash
# Bus支持多次订阅同一类别
bus->subscribe([](const BusMessage& msg) { /* 处理1 */ });
bus->subscribe([](const BusMessage& msg) { /* 处理2 */ });
# 发布消息时，所有订阅者都会收到
```

### Q3: 内存泄漏
```bash
# 确保取消订阅
bus->unsubscribe(id);
// 或使用智能指针管理Bus生命周期
```

## 输出示例

### x86平台运行输出
```
================================================================================
                FalconMindSDK 示例04: Bus消息总线 (x86)
================================================================================

[1] 创建Bus消息总线
    Bus实例创建成功

[2] 订阅检测消息
    订阅检测消息，ID: 1

[3] 订阅遥测消息
    订阅遥测消息，ID: 2

[4] 订阅日志消息
    订阅日志消息，ID: 3

[5] 发布检测消息
    [检测] detection: 目标检测结果: 车辆, 置信度: 0.95

[6] 发布遥测消息
    [遥测] telemetry: 高度: 100m, 速度: 20m/s

[7] 发布日志消息
    [日志] log: 系统运行正常

[8] 发布状态消息
    [状态] status: 节点状态: RUNNING

    +----------------+     +----------------+     +----------------+
    |   Publisher    |────▶|     Bus       |────▶|  Subscriber   |
    |                |     |                |     |                |
    │   发布消息     │     │   消息路由     │     │   接收处理     │
    +----------------+     +----------------+     +----------------+

[9] 取消订阅(检测)
    取消订阅: 1

[10] 验证取消订阅
    订阅者数量: 2

================================================================================
                    测试通过: Bus核心API验证成功
================================================================================
```

## 注意事项

1. **SDK依赖**: 确保FalconMindSDK核心库已编译
2. **平台选择**: 根据目标平台选择对应的交叉编译工具链
3. **订阅管理**: 及时取消不需要的订阅，避免内存泄漏
4. **消息频率**: 避免高频消息导致性能问题

## 相关文档

- [FalconMindSDK核心API文档](../SDK_core_API.md)
- [Bus设计文档](../Doc/Bus_Design.md)
- [CMake交叉编译配置](../Doc/Cross_Compilation.md)

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0.0 | 2026-02-09 | 初始版本，支持4个平台 |
