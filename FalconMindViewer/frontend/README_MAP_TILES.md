# 地图瓦片预下载指南

> **最后更新**: 2024-01-30

## 📚 相关文档

- **README.md** - 前端使用说明
- **../README.md** - Viewer 总体说明
- **Doc/06_FalconMindViewer_Design.md** - Viewer 详细设计文档

## 地图瓦片预下载指南

本指南说明如何预先下载地图瓦片到本地，实现离线使用和更快的加载速度。

## 快速开始

### 1. 下载北京市地图瓦片（推荐用于测试）

```bash
cd FalconMindViewer/frontend
python3 download_map_tiles.py --beijing --max-zoom 14
```

这将下载北京市区域（116.0-117.0°E, 39.5-40.5°N）的瓦片，缩放级别 0-14。

### 2. 下载全中国地图瓦片

```bash
cd FalconMindViewer/frontend
# 推荐使用较低的缩放级别（10-12），避免下载过多数据
python3 download_map_tiles.py --china --max-zoom 10
```

这将下载全中国区域（73.0-135.0°E, 18.0-54.0°N）的瓦片。

**重要提示**：
- 全中国范围很大，建议使用 `--max-zoom 10` 或 `12`
- 缩放级别 10：约 100 万个瓦片，~20 GB
- 缩放级别 12：约 1,600 万个瓦片，~320 GB
- 缩放级别 14：约 2.5 亿个瓦片，~5 TB（不推荐）

### 2. 使用本地瓦片

下载完成后，`app.js` 会自动使用本地瓦片。如果本地瓦片不存在，会自动回退到在线服务器。

## 详细说明

### 下载指定区域

```bash
python3 download_map_tiles.py \
  --min-lat 39.5 \
  --min-lon 116.0 \
  --max-lat 40.5 \
  --max-lon 117.0 \
  --min-zoom 0 \
  --max-zoom 14 \
  --output tiles
```

### 参数说明

- `--min-lat`, `--min-lon`: 区域左下角坐标（纬度、经度）
- `--max-lat`, `--max-lon`: 区域右上角坐标（纬度、经度）
- `--min-zoom`: 最小缩放级别（默认: 0）
- `--max-zoom`: 最大缩放级别（默认: 14）
  - 缩放级别越高，瓦片数量越多，细节越丰富
  - 建议值：
    - 城市概览: 10-12
    - 详细查看: 13-15
    - 非常详细: 16-18（瓦片数量会非常大）
- `--output`: 输出目录（默认: `tiles`）
- `--workers`: 并发下载线程数（默认: 10）
- `--delay`: 每个请求之间的延迟/秒（默认: 0.1，避免被服务器限流）
- `--beijing`: 使用北京市预设区域

### 瓦片存储结构

下载的瓦片按以下结构存储：

```
tiles/
├── 0/          # 缩放级别 0
│   └── 0/
│       └── 0.png
├── 1/          # 缩放级别 1
│   ├── 0/
│   │   ├── 0.png
│   │   └── 1.png
│   └── 1/
│       ├── 0.png
│       └── 1.png
├── 2/
└── ...
```

### 瓦片数量估算

不同缩放级别的瓦片数量：

- 缩放级别 0: 1 个瓦片
- 缩放级别 1: 4 个瓦片
- 缩放级别 2: 16 个瓦片
- 缩放级别 n: 4^n 个瓦片

对于北京市区域（约 1°×1°），不同缩放级别的瓦片数量：

- 缩放级别 10: ~100 个瓦片
- 缩放级别 12: ~1,600 个瓦片
- 缩放级别 14: ~25,600 个瓦片
- 缩放级别 16: ~409,600 个瓦片

**建议**：
- 首次下载使用 `--max-zoom 12` 或 `14`
- 如果需要更详细的区域，可以单独下载该区域的高级别瓦片

### 使用本地瓦片

`app.js` 会自动检测并使用本地瓦片。如果本地瓦片不存在或加载失败，会自动回退到在线服务器。

### 更新瓦片

如果需要更新瓦片，只需重新运行下载脚本。已存在的瓦片会被跳过（除非删除）。

### 清理瓦片

```bash
rm -rf tiles/
```

## 常见区域预设

### 北京市

```bash
python3 download_map_tiles.py --beijing --max-zoom 14
```

范围：116.0-117.0°E, 39.5-40.5°N

### 自定义区域

```bash
python3 download_map_tiles.py \
  --min-lat <最小纬度> \
  --min-lon <最小经度> \
  --max-lat <最大纬度> \
  --max-lon <最大经度> \
  --max-zoom 14
```

## 注意事项

1. **遵守使用条款**：OpenStreetMap 瓦片的使用需要遵守 [OSM 使用条款](https://www.openstreetmap.org/copyright)
2. **服务器限流**：下载时建议使用 `--delay 0.1` 或更大值，避免被服务器限流
3. **存储空间**：高级别缩放会生成大量瓦片，注意磁盘空间
4. **网络连接**：首次下载需要稳定的网络连接
5. **瓦片更新**：地图数据会定期更新，建议定期重新下载重要区域

## 故障排除

### 下载失败

- 检查网络连接
- 增加 `--delay` 值（如 `--delay 0.2`）
- 减少并发线程数（如 `--workers 5`）

### 瓦片不显示

- 检查 `tiles/` 目录是否存在
- 检查瓦片文件路径是否正确
- 检查浏览器控制台是否有错误
- 确认 `app.js` 中的 `useLocalTiles` 设置

### 瓦片加载慢

- 使用本地 HTTP 服务器（如 `python3 -m http.server`）
- 检查瓦片文件大小和数量
- 考虑使用更高级别的缓存
